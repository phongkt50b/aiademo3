<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Viewer Bảng Minh Họa</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
  --max-width: 1000px;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}
body {
  margin:0;
  background:#fafafa;
  color:#222;
  line-height:1.5;
}
header {
  background:#fff;
  border-bottom:1px solid #e5e5e5;
  position:sticky; top:0; z-index:20;
}
#toolbar {
  max-width:var(--max-width);
  margin:0 auto;
  padding:12px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:12px;
}
#toolbar h1 { margin:0; font-size:18px; font-weight:600; }
button {
  cursor:pointer;
  background:#d4002a;
  border:1px solid #d4002a;
  color:#fff;
  padding:8px 14px;
  font-size:14px;
  border-radius:4px;
}
button.secondary {
  background:#f5f5f5;
  color:#222;
  border:1px solid #ccc;
}
main {
  max-width:var(--max-width);
  margin:28px auto 80px;
  padding:0 18px;
}
.status {
  font-size:14px;
  color:#555;
  display:flex;
  align-items:center;
  gap:6px;
}
.status::before {
  content:"";
  width:14px; height:14px;
  border:2px solid #d4002a;
  border-right-color:transparent;
  border-radius:50%;
  animation:spin .9s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg);} }
.hidden { display:none !important; }

/* Khối ảnh full-width */
.viewer-image-block {
  margin:40px 0 48px;
}
.viewer-image-block figure {
  margin:0 0 32px;
  background:#fff;
  border:1px solid #e5e5e5;
  border-radius:8px;
  padding:10px;
  box-shadow:0 2px 4px rgba(0,0,0,.05);
  cursor:zoom-in;
  transition:box-shadow .25s;
}
.viewer-image-block figure:hover {
  box-shadow:0 5px 20px rgba(0,0,0,.15);
}
.viewer-image-block img {
  width:100%;
  height:auto;
  display:block;
  border-radius:4px;
  object-fit:contain;
}
.viewer-image-block figcaption { display:none !important; }

/* Lightbox */
#lightboxOverlay {
  position:fixed; inset:0;
  background:rgba(0,0,0,.85);
  display:flex; align-items:center; justify-content:center;
  padding:40px 30px;
  z-index:999;
  opacity:0; pointer-events:none;
  transition:opacity .25s;
}
#lightboxOverlay.active {
  opacity:1; pointer-events:auto;
}
#lightboxOverlay img {
  max-width:95vw;
  max-height:95vh;
  object-fit:contain;
  background:#111;
  border:1px solid #444;
  border-radius:4px;
  box-shadow:0 10px 30px rgba(0,0,0,.6);
  cursor:zoom-out;
}
#lightboxOverlay .close-btn {
  position:fixed;
  top:14px; right:22px;
  font-size:32px; color:#fff;
  cursor:pointer;
  user-select:none;
  line-height:1;
}
.lb-nav-btn {
  position:fixed;
  top:50%; transform:translateY(-50%);
  width:58px; height:58px;
  display:flex; align-items:center; justify-content:center;
  border-radius:50%;
  font-size:40px;
  background:rgba(255,255,255,.18);
  color:#fff; border:none; cursor:pointer;
  transition:background .25s;
}
.lb-nav-btn:hover { background:rgba(255,255,255,.35); }
.lb-prev { left:30px; }
.lb-next { right:30px; }

/* Print */
@media print {
  header, #lightboxOverlay { display:none !important; }
  body { background:#fff; }
  .viewer-image-block figure { page-break-inside:avoid; }
}

#summary-wrapper {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  color: #222;
  line-height: 1.5;
  max-width: 100%;
  overflow-x: auto;
  padding-bottom: 14px;
}
#summary-wrapper {
  font-size: 14px; /* cỡ chữ chuẩn bạn muốn (dựa theo bảng phần 1, 2, 3 hiện tại) */
  line-height: 1.5;
}
#summary-wrapper * {
  font-size: inherit !important; /* kế thừa cỡ chữ từ #summary-wrapper, ưu tiên override các cỡ chữ khác */
}

#summary-wrapper h3 {
  font-weight: 600;
  margin-top: 14px;
  margin-bottom: 14px;
  color: #b91c1c; /* đỏ đậm */
}

#summary-wrapper table {
  width: 100%;
  border-collapse: collapse;
  border: 1px solid #ddd;
  margin-bottom: 14px;
  font-size: 14px;
  background: #fff;
}

#summary-wrapper th, 
#summary-wrapper td {
  border: 1px solid #ddd;
  padding: 8px 12px;
  vertical-align: top;
  text-align: left;
}

#summary-wrapper th {
  background-color: #f3f4f6;
  font-weight: 600;
  color: #444;
  text-align: center; /* Tiêu đề căn giữa tất cả bảng */
}

#summary-wrapper tr:nth-child(even) {
  background-color: #fafafa;
}

#summary-wrapper strong {
  font-weight: 600;
}

#summary-wrapper .text-red-600 {
  color: #b91c1c;
}

/* --- Phần 1: Bảng tóm tắt sản phẩm --- */
/* Căn phải từ cột 3 (STBH) trở đi */
#summary-wrapper table:nth-of-type(1) td:nth-child(n+3) {
  text-align: right;
}
/* Dòng tổng cuối cùng của bảng 1 */
/* Ô đầu tiên căn trái và bôi đậm */
#summary-wrapper table:nth-of-type(1) tr:last-child td:first-child {
  text-align: left;
}
/* Các ô còn lại căn phải và bôi đậm */
#summary-wrapper table:nth-of-type(1) tr:last-child td:not(:first-child) {
  text-align: right;
}
  </style>
</head>
<body>
  <header>
    <div id="toolbar">
      <h1>Bảng minh họa (Viewer)</h1>
      <div class="actions">
        <button id="btnExportPdf">In / PDF</button>
        <button id="btnExportHtml">Tải HTML</button>
        <button class="secondary" id="btnReload">Tải lại</button>
      </div>
    </div>
  </header>
  <main id="content">
    <div id="status" class="status">Đang tải dữ liệu...</div>
  </main>

  <!-- LIGHTBOX -->
  <div id="lightboxOverlay">
    <span class="close-btn" aria-label="Đóng">×</span>
    <button class="lb-nav-btn lb-prev" title="Trước">‹</button>
    <img src="" alt="">
    <button class="lb-nav-btn lb-next" title="Sau">›</button>
  </div>

  <script>
  (function(){
    const state = {
      payload:null,
      images:[],
      currentIndex:0
    };

    function decodePayload(){
      const h = location.hash || '';
      if(!h.startsWith('#v=')) throw new Error('Thiếu payload (#v=...)');
      const b64 = h.slice(3);
      const json = decodeURIComponent(escape(atob(b64)));
      return JSON.parse(json);
    }

    function qs(sel,root=document){ return root.querySelector(sel); }
    function qa(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }

    function buildSummaryHtmlFromPayload(p){
      return p.summaryHtml || '<div class="text-red-600">Không có summaryHtml trong payload.</div>';
    }

    /* ---------- IMAGE LOADING ---------- */
    async function headExists(url){
      try {
        const res = await fetch(url,{method:'HEAD',cache:'no-store'});
        return res.ok;
      } catch(_e){ return false; }
    }

    // Hàm mới: tải tuần tự tối đa max ảnh, dừng khi gặp ảnh không tồn tại
    async function collectSequentialLimited(baseDir, baseName, max=10){
      const out = [];
      for(let i=1; i<=max; i++){
        const num = String(i).padStart(2,'0');
        const url = `${baseDir}/${baseName}-${num}.jpg`;
        if(await headExists(url)){
          out.push(url);
        } else {
          break; // dừng khi ảnh kế tiếp không tồn tại
        }
      }
      return out;
    }

    function renderImageBlock(urls){
      if(!urls.length) return null;
      const wrap=document.createElement('div');
      wrap.className='viewer-image-block';
      urls.forEach(u=>{
        const fig=document.createElement('figure');
        const img=document.createElement('img');
        img.src=u;
        img.alt='';
        img.loading = 'lazy'; // Thêm lazy load ảnh
        fig.appendChild(img);
        fig.addEventListener('click',()=>openLightbox(u));
        wrap.appendChild(fig);
      });
      state.images = state.images.concat(urls);
      return wrap;
    }

    /* ---------- LIGHTBOX ---------- */
    function setupLightbox(){
      const overlay=qs('#lightboxOverlay');
      const img=overlay.querySelector('img');
      const closeBtn=overlay.querySelector('.close-btn');
      const prevBtn=overlay.querySelector('.lb-prev');
      const nextBtn=overlay.querySelector('.lb-next');

      function show(idx){
        if(idx<0||idx>=state.images.length) return;
        state.currentIndex=idx;
        img.src=state.images[idx];
        overlay.classList.add('active');
        updateNav();
      }
      function hide(){
        overlay.classList.remove('active');
        img.src='';
      }
      function updateNav(){
        prevBtn.disabled=(state.currentIndex===0);
        nextBtn.disabled=(state.currentIndex===state.images.length-1);
      }
      function shift(d){
        const ni=state.currentIndex+d;
        if(ni>=0 && ni<state.images.length) show(ni);
      }

      prevBtn.addEventListener('click',()=>shift(-1));
      nextBtn.addEventListener('click',()=>shift(1));
      closeBtn.addEventListener('click',hide);
      overlay.addEventListener('click',e=>{ if(e.target===overlay) hide(); });
      document.addEventListener('keydown',e=>{
        if(!overlay.classList.contains('active')) return;
        if(e.key==='Escape') hide();
        if(e.key==='ArrowLeft') shift(-1);
        if(e.key==='ArrowRight') shift(1);
      });
      window._lbOpenSrc = (src)=>{
        const idx=state.images.indexOf(src);
        if(idx!==-1) show(idx);
      };
    }
    function openLightbox(src){
      if(window._lbOpenSrc) window._lbOpenSrc(src);
    }

    /* ---------- MAIN RENDER ---------- */
    async function render(){
      const payload = state.payload;
      const main = qs('#content');
      const statusEl = qs('#status');
      statusEl.classList.add('hidden');
      main.innerHTML = '';
      state.images = [];

      // 1. Gắn summaryHtml
      const summaryHtml = buildSummaryHtmlFromPayload(payload);
      const container = document.createElement('div');
      container.id = 'summary-wrapper';
      container.innerHTML = summaryHtml;
      main.appendChild(container);

      // <-- Thêm đoạn fix căn chỉnh bảng ở đây -->
      function fixTableAlignments() {
        const tables = container.querySelectorAll('table');
        if (tables.length === 0) return;
      
        // Bảng phần 2 là tất cả bảng từ vị trí bảng thứ 2 đến trước bảng thứ 3
        // Vì phần 1 là bảng 1, phần 3 là bảng 3, phần 2 là các bảng ở giữa (có thể nhiều bảng)
        // Nên phần 2 sẽ là bảng thứ 2 (index 1) nếu có 1 bảng, hoặc nhiều bảng từ 1 đến 2 (nếu có 3 bảng)
        
        // Cách an toàn: phần 1 = bảng 1 (index 0), phần 3 = bảng cuối cùng (index tables.length - 1),
        // phần 2 là tất cả bảng nằm giữa (index từ 1 đến tables.length-2)
        
        // Căn chỉnh phần 2: cột đầu trái, các cột còn lại phải
        for(let i=1; i < tables.length - 1; i++) {
          const table = tables[i];
          table.querySelectorAll('tbody tr').forEach(tr => {
            tr.querySelectorAll('td').forEach((td, idx) => {
              if (idx === 0) td.style.textAlign = 'left';
              else td.style.textAlign = 'right';
            });
          });
        }
      
        // Căn chỉnh phần 3 (bảng cuối cùng): 2 cột đầu căn giữa, các cột còn lại phải
        const lastTable = tables[tables.length - 1];
        if (lastTable) {
          lastTable.querySelectorAll('tbody tr').forEach(tr => {
            tr.querySelectorAll('td').forEach((td, idx) => {
              if (idx === 0 || idx === 1) td.style.textAlign = 'center';
              else td.style.textAlign = 'right';
            });
          });
        }
      }
      fixTableAlignments();

      // --- Thêm đoạn này ---
      const rows = container.querySelectorAll('tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes('tổng') || text.includes('quyền lợi thai sản') || text.includes('quyền lợi ngoại trú') || text.includes('quyền lợi nha khoa')|| text.includes('điều trị ung thư')) {
          row.style.fontWeight = '700';
        }
      });

      // 2. Chèn ảnh công ty TRƯỚC TOÀN BỘ bảng minh họa (trước container)
      const companyImgs = await collectSequentialLimited('images/company','company',10);
      console.log('Company images:', companyImgs);
      const companyBlock = renderImageBlock(companyImgs);
      if(companyBlock){
        if(container.parentNode){
          container.parentNode.insertBefore(companyBlock, container);
        } else {
          // fallback nếu container chưa có parent
          container.prepend(companyBlock);
        }
      }

      // 3. Chèn ảnh sản phẩm chính và riders sau phần 3 (giới hạn 10 ảnh mỗi loại)
      const part3Headings = qa('h3', container).filter(h => /Phần\s*3/i.test(h.textContent));
      const lastPart3 = part3Headings.length ? part3Headings[part3Headings.length - 1] : null;
      let insertAfterNode = lastPart3 ? lastPart3.parentElement : container.lastElementChild;

      // 3.1 Ảnh sản phẩm chính
      const prodSlug = payload.productSlug || (payload.productKey || '').toLowerCase();
      const productImgs = await collectSequentialLimited(`images/products/${prodSlug}`, prodSlug, 10);
      console.log('Product images:', productImgs);
      if(productImgs.length){
        const prodBlock = renderImageBlock(productImgs);
        if(insertAfterNode && insertAfterNode.parentNode){
          insertAfterNode.parentNode.insertBefore(prodBlock, insertAfterNode.nextSibling);
          insertAfterNode = prodBlock;
        } else {
          container.appendChild(prodBlock);
          insertAfterNode = prodBlock;
        }
      }

      // 3.2 Ảnh riders
      if(Array.isArray(payload.premiums?.riders)){
        for(const r of payload.premiums.riders){
          if(!r.selected) continue;
          const riderSlugMap = {
            health_scl:'bung-gia-luc',
            bhn:'benh-hiem-ngheo-20',
            accident:'tai-nan',
            hospital_support:'ho-tro-vien-phi',
          };
          const rSlug = riderSlugMap[r.slug];
          if(!rSlug) continue;
          const riderImgs = await collectSequentialLimited(`images/products/${rSlug}`, rSlug, 10);
          console.log(`Rider images (${r.slug}):`, riderImgs);
          if(riderImgs.length){
            const riderBlock = renderImageBlock(riderImgs);
            if(insertAfterNode && insertAfterNode.parentNode){
              insertAfterNode.parentNode.insertBefore(riderBlock, insertAfterNode.nextSibling);
              insertAfterNode = riderBlock;
            } else {
              container.appendChild(riderBlock);
              insertAfterNode = riderBlock;
            }
          }
        }
      }
    }

    // Hàm tải HTML giữ nguyên style gốc
    function exportHtmlWithStyle() {
      const container = document.querySelector('#summary-wrapper');
      if (!container) {
        alert('Không có nội dung để tải.');
        return;
      }
      const innerHtml = container.innerHTML;

      // Lấy toàn bộ nội dung style trong <head>
      const styles = Array.from(document.querySelectorAll('head style, head link[rel="stylesheet"]'))
        .map(node => {
          if(node.tagName.toLowerCase() === 'style') {
            return node.outerHTML;
          } else if(node.tagName.toLowerCase() === 'link') {
            return node.outerHTML;
          }
          return '';
        }).join('\n');

      const fullHtml = `
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Bảng Minh Họa - Xuất HTML</title>
  ${styles}
</head>
<body>
  <div id="summary-wrapper">
    ${innerHtml}
  </div>
</body>
</html>`;

      const blob = new Blob([fullHtml], {type: 'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bang-minh-hoa.html';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }

    function setupButtons(){
      qs('#btnExportPdf').addEventListener('click', ()=>window.print());
      qs('#btnExportHtml').addEventListener('click', exportHtmlWithStyle);
      qs('#btnReload').addEventListener('click', ()=>location.reload());
    }
    function init(){
      setupButtons();
      setupLightbox();
      try {
        state.payload = decodePayload();
        render();
      } catch(e){
        console.error(e);
        const st=qs('#status');
        st.textContent='Không đọc được dữ liệu.';
      }
    }
    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
