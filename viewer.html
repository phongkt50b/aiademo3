<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Viewer Bảng Minh Họa</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --max-width: 1000px;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    body {
      margin:0;
      background:#fafafa;
      color:#222;
      line-height:1.5;
    }
    header {
      background:#fff;
      border-bottom:1px solid #e5e5e5;
      position:sticky; top:0; z-index:20;
    }
    #toolbar {
      max-width:var(--max-width);
      margin:0 auto;
      padding:12px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
    }
    #toolbar h1 { margin:0; font-size:18px; font-weight:600; }
    button {
      cursor:pointer;
      background:#d4002a;
      border:1px solid #d4002a;
      color:#fff;
      padding:8px 14px;
      font-size:14px;
      border-radius:4px;
    }
    button.secondary {
      background:#f5f5f5;
      color:#222;
      border:1px solid #ccc;
    }
    main {
      max-width:var(--max-width);
      margin:28px auto 80px;
      padding:0 18px;
    }
    .status {
      font-size:14px;
      color:#555;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .status::before {
      content:"";
      width:14px; height:14px;
      border:2px solid #d4002a;
      border-right-color:transparent;
      border-radius:50%;
      animation:spin .9s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg);} }
    .hidden { display:none !important; }

    /* Khối ảnh full-width */
    .viewer-image-block {
      margin:40px 0 48px;
    }
    .viewer-image-block figure {
      margin:0 0 32px;
      background:#fff;
      border:1px solid #e5e5e5;
      border-radius:8px;
      padding:10px;
      box-shadow:0 2px 4px rgba(0,0,0,.05);
      cursor:zoom-in;
      transition:box-shadow .25s;
    }
    .viewer-image-block figure:hover {
      box-shadow:0 5px 20px rgba(0,0,0,.15);
    }
    .viewer-image-block img {
      width:100%;
      height:auto;
      display:block;
      border-radius:4px;
      object-fit:contain;
    }
    .viewer-image-block figcaption { display:none !important; }

    /* Lightbox */
    #lightboxOverlay {
      position:fixed; inset:0;
      background:rgba(0,0,0,.85);
      display:flex; align-items:center; justify-content:center;
      padding:40px 30px;
      z-index:999;
      opacity:0; pointer-events:none;
      transition:opacity .25s;
    }
    #lightboxOverlay.active {
      opacity:1; pointer-events:auto;
    }
    #lightboxOverlay img {
      max-width:95vw;
      max-height:95vh;
      object-fit:contain;
      background:#111;
      border:1px solid #444;
      border-radius:4px;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
      cursor:zoom-out;
    }
    #lightboxOverlay .close-btn {
      position:fixed;
      top:14px; right:22px;
      font-size:32px; color:#fff;
      cursor:pointer;
      user-select:none;
      line-height:1;
    }
    .lb-nav-btn {
      position:fixed;
      top:50%; transform:translateY(-50%);
      width:58px; height:58px;
      display:flex; align-items:center; justify-content:center;
      border-radius:50%;
      font-size:40px;
      background:rgba(255,255,255,.18);
      color:#fff; border:none; cursor:pointer;
      transition:background .25s;
    }
    .lb-nav-btn:hover { background:rgba(255,255,255,.35); }
    .lb-prev { left:30px; }
    .lb-next { right:30px; }

    /* Print */
    @media print {
      header, #lightboxOverlay { display:none !important; }
      body { background:#fff; }
      .viewer-image-block figure { page-break-inside:avoid; }
    }
  </style>
</head>
<body>
  <header>
    <div id="toolbar">
      <h1>Bảng minh họa (Viewer)</h1>
      <div class="actions">
        <button id="btnExportPdf">In / PDF</button>
        <button class="secondary" id="btnReload">Tải lại</button>
      </div>
    </div>
  </header>
  <main id="content">
    <div id="status" class="status">Đang tải dữ liệu...</div>
  </main>

  <!-- LIGHTBOX -->
  <div id="lightboxOverlay">
    <span class="close-btn" aria-label="Đóng">×</span>
    <button class="lb-nav-btn lb-prev" title="Trước">‹</button>
    <img src="" alt="">
    <button class="lb-nav-btn lb-next" title="Sau">›</button>
  </div>

  <script>
  (function(){
    const state = {
      payload:null,
      images:[],
      currentIndex:0
    };

    function decodePayload(){
      const h = location.hash || '';
      if(!h.startsWith('#v=')) throw new Error('Thiếu payload (#v=...)');
      const b64 = h.slice(3);
      const json = decodeURIComponent(escape(atob(b64)));
      return JSON.parse(json);
    }

    function qs(sel,root=document){ return root.querySelector(sel); }
    function qa(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }

    function buildSummaryHtmlFromPayload(p){
      // p.summaryHtml đã chứa nguyên văn nội dung bảng tóm tắt (Phần 1,2,3, footer)
      return p.summaryHtml || '<div class="text-red-600">Không có summaryHtml trong payload.</div>';
    }

    /* ---------- IMAGE LOADING ---------- */
    async function headExists(url){
      try {
        const res = await fetch(url,{method:'HEAD',cache:'no-store'});
        return res.ok;
      } catch(_e){ return false; }
    }
    async function collectSequential(baseDir, baseName, max=40){
      const out=[];
      for(let i=1;i<=max;i++){
        const num=String(i).padStart(2,'0');
        const url=`${baseDir}/${baseName}-${num}.jpg`;
        if(await headExists(url)) out.push(url);
        else {
          if(i===1) break;
          else break;
        }
      }
      return out;
    }

    function renderImageBlock(urls){
      if(!urls.length) return null;
      const wrap=document.createElement('div');
      wrap.className='viewer-image-block';
      urls.forEach(u=>{
        const fig=document.createElement('figure');
        const img=document.createElement('img');
        img.src=u;
        img.alt='';
        fig.appendChild(img);
        fig.addEventListener('click',()=>openLightbox(u));
        wrap.appendChild(fig);
        state.images.push(u);
      });
      return wrap;
    }

    /* ---------- LIGHTBOX ---------- */
    function setupLightbox(){
      const overlay=qs('#lightboxOverlay');
      const img=overlay.querySelector('img');
      const closeBtn=overlay.querySelector('.close-btn');
      const prevBtn=overlay.querySelector('.lb-prev');
      const nextBtn=overlay.querySelector('.lb-next');

      function show(idx){
        if(idx<0||idx>=state.images.length) return;
        state.currentIndex=idx;
        img.src=state.images[idx];
        overlay.classList.add('active');
        updateNav();
      }
      function hide(){
        overlay.classList.remove('active');
        img.src='';
      }
      function updateNav(){
        prevBtn.disabled=(state.currentIndex===0);
        nextBtn.disabled=(state.currentIndex===state.images.length-1);
      }
      function shift(d){
        const ni=state.currentIndex+d;
        if(ni>=0 && ni<state.images.length) show(ni);
      }

      prevBtn.addEventListener('click',()=>shift(-1));
      nextBtn.addEventListener('click',()=>shift(1));
      closeBtn.addEventListener('click',hide);
      overlay.addEventListener('click',e=>{ if(e.target===overlay) hide(); });
      document.addEventListener('keydown',e=>{
        if(!overlay.classList.contains('active')) return;
        if(e.key==='Escape') hide();
        if(e.key==='ArrowLeft') shift(-1);
        if(e.key==='ArrowRight') shift(1);
      });
      window._lbOpenSrc = (src)=>{
        const idx=state.images.indexOf(src);
        if(idx!==-1) show(idx);
      };
    }
    function openLightbox(src){
      if(window._lbOpenSrc) window._lbOpenSrc(src);
    }

    /* ---------- MAIN RENDER ---------- */
    async function render(){
      const payload = state.payload;
      const main = qs('#content');
      const statusEl = qs('#status');
      statusEl.classList.add('hidden');

      // 1. Gắn nguyên văn summaryHtml
      const summaryHtml = buildSummaryHtmlFromPayload(payload);
      const container = document.createElement('div');
      container.id='summary-wrapper';
      container.innerHTML = summaryHtml;
      main.appendChild(container);

      // 2. Chèn ảnh công ty trước Phần 1
      const part1Heading = qa('h3', container).find(h=>/Phần\s*1/i.test(h.textContent));
      const companyImgs = await collectSequential('images/company','company',50);
      const companyBlock = renderImageBlock(companyImgs);
      if(companyBlock){
        if(part1Heading) container.insertBefore(companyBlock, part1Heading.parentElement);
        else container.prepend(companyBlock);
      }

      // 3. Chèn ảnh sản phẩm chính + ảnh riders sau Phần 3
      const part3Headings = qa('h3', container).filter(h=>/Phần\s*3/i.test(h.textContent));
      const lastPart3 = part3Headings.length ? part3Headings[part3Head3.length-1].parentElement : container.lastElementChild;
      
      // 3.1 Ảnh sản phẩm chính
      const prodSlug = payload.productSlug || (payload.productKey||'').toLowerCase();
      const productImgs = await collectSequential(`images/products/${prodSlug}`, prodSlug, 60);
      if(productImgs.length){
        const prodBlock = renderImageBlock(productImgs);
        lastPart3.after(prodBlock);
      }
      
      // 3.2 Ảnh riders theo thứ tự trong payload.premiums.riders
      if(Array.isArray(payload.premiums?.riders)){
        let lastNode = lastPart3.nextElementSibling || lastPart3;
        for(const r of payload.premiums.riders){
          if(!r.selected) continue;
          // Map slug rider sang thư mục ảnh
          const riderSlugMap = {
            health_scl:'bung-gia-luc',
            bhn:'benh-hiem-ngheo-20',
            accident:'tai-nan',
            hospital_support:'ho-tro-vien-phi',
            mdp3:null // MDP3 không có ảnh
          };
          const rSlug = riderSlugMap[r.slug];
          if(!rSlug) continue;
          const riderImgs = await collectSequential(`images/products/${rSlug}`, rSlug, 60);
          if(riderImgs.length){
            const riderBlock = renderImageBlock(riderImgs);
            lastNode.after(riderBlock);
            lastNode = riderBlock;
          }
        }
      }

    }

    function setupButtons(){
      qs('#btnExportPdf').addEventListener('click', ()=>window.print());
      qs('#btnReload').addEventListener('click', ()=>location.reload());
    }

    function init(){
      setupButtons();
      setupLightbox();
      try {
        state.payload = decodePayload();
        render();
      } catch(e){
        console.error(e);
        const st=qs('#status');
        st.textContent='Không đọc được dữ liệu.';
      }
    }
    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
