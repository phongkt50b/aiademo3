<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Viewer Bảng Phí</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --max-width: 1000px;
      --gap: 24px;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color-scheme: light;
    }
    body {
      margin:0;
      background:#fafafa;
      color:#222;
      line-height:1.5;
    }
    header {
      background:#fff;
      border-bottom:1px solid #e5e5e5;
      position:sticky;
      top:0;
      z-index:50;
    }
    #toolbar {
      max-width:var(--max-width);
      margin:0 auto;
      padding:12px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    #toolbar h1 {
      margin:0;
      font-size:18px;
      font-weight:600;
    }
    #toolbar .actions {
      display:flex;
      gap:8px;
    }
    button {
      cursor:pointer;
      background:#d4002a;
      border:1px solid #d4002a;
      color:#fff;
      padding:8px 14px;
      font-size:14px;
      border-radius:4px;
    }
    button.secondary {
      background:#f5f5f5;
      color:#333;
      border:1px solid #ccc;
    }
    main {
      max-width:var(--max-width);
      margin:30px auto 80px;
      padding:0 18px;
    }
    h2.section-title {
      font-size:20px;
      margin:60px 0 20px;
      font-weight:600;
      border-left:5px solid #d4002a;
      padding-left:12px;
    }
    table {
      width:100%;
      border-collapse:collapse;
      margin:8px 0 32px;
      font-size:13px;
      background:#fff;
    }
    th, td {
      border:1px solid #ddd;
      padding:6px 8px;
    }
    th {
      background:#f2f2f2;
      text-align:center;
      font-weight:600;
    }
    td {
      text-align:right;
    }
    td:first-child, td:nth-child(2) {
      text-align:center;
    }
    .note {
      font-size:12px;
      color:#444;
      margin-top:4px;
      margin-bottom:20px;
      background:#fff;
      padding:8px 10px;
      border:1px solid #eee;
      border-radius:4px;
      line-height:1.4;
    }

    /* GALLERY (KHÔNG tiêu đề & KHÔNG caption) */
    .gallery-block {
      margin:40px 0;
    }
    .gallery-list {
      display:grid;
      gap:14px;
      grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
    }
    .gallery-list figure {
      margin:0;
      padding:8px;
      background:#fff;
      border:1px solid #e5e5e5;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:140px;
      cursor:zoom-in;
      transition:box-shadow .2s, transform .2s;
    }
    .gallery-list figure:hover {
      box-shadow:0 4px 14px rgba(0,0,0,.12);
      transform:translateY(-2px);
    }
    .gallery-list img {
      width:100%;
      height:auto;
      display:block;
      object-fit:contain;
      max-height:220px;
    }
    .gallery-list figcaption { display:none !important; }

    /* LIGHTBOX */
    #lightboxOverlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.85);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:40px 30px;
      z-index:999;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s;
    }
    #lightboxOverlay.active {
      opacity:1;
      pointer-events:auto;
    }
    #lightboxOverlay img {
      max-width:95vw;
      max-height:95vh;
      object-fit:contain;
      border:1px solid #444;
      background:#111;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
      border-radius:4px;
      cursor:zoom-out;
    }
    #lightboxOverlay .close-btn {
      position:fixed;
      top:14px;
      right:22px;
      font-size:32px;
      color:#fff;
      cursor:pointer;
      user-select:none;
      line-height:1;
    }
    .lb-nav {
      position:fixed;
      top:50%;
      transform:translateY(-50%);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .lb-prev, .lb-next {
      background:rgba(255,255,255,.15);
      border:none;
      color:#fff;
      font-size:32px;
      width:52px;
      height:52px;
      border-radius:50%;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background .2s;
    }
    .lb-prev:hover, .lb-next:hover { background:rgba(255,255,255,.3); }

    /* STATUS */
    .status {
      font-size:14px;
      color:#555;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .status::before {
      content:"";
      width:14px;
      height:14px;
      border:2px solid #d4002a;
      border-right-color:transparent;
      border-radius:50%;
      animation:spin .9s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    .hidden { display:none !important; }

    /* PRINT */
    @media print {
      header, #lightboxOverlay { display:none !important; }
      body { background:#fff; }
      .gallery-block { page-break-after:always; }
      table { font-size:11px; }
      .note { font-size:10px; }
    }
  </style>
</head>
<body>
  <header>
    <div id="toolbar">
      <h1>Bảng minh họa (Viewer)</h1>
      <div class="actions">
        <button id="btnExportPdf" title="Xuất PDF">Xuất PDF</button>
        <button class="secondary" id="btnReload" title="Tải lại">Tải lại</button>
      </div>
    </div>
  </header>
  <main id="mainContent">
    <div id="status" class="status">Đang đọc dữ liệu...</div>
    <div id="feeSection"></div>
    <!-- GALLERY (ảnh công ty + ảnh sản phẩm + ảnh riders) -->
    <div id="galleryAnchor"></div>
  </main>

  <!-- LIGHTBOX -->
  <div id="lightboxOverlay">
    <span class="close-btn" aria-label="Đóng">×</span>
    <button class="lb-prev lb-nav" style="left:30px;">‹</button>
    <img src="" alt="Preview">
    <button class="lb-next lb-nav" style="right:30px;">›</button>
  </div>

  <script>
    (function(){
      const state = {
        payload:null,
        galleryBuilt:false,
        lightboxItems:[],
        lbIndex:0
      };

      const PRODUCT_NAME_MAP = {
        PUL_TRON_DOI:'Khoẻ trọn vẹn - Trọn đời',
        PUL_15NAM:'Khoẻ trọn vẹn - 15 năm',
        PUL_5NAM:'Khoẻ trọn vẹn - 5 năm',
        KHOE_BINH_AN:'MUL - Khoẻ Bình An',
        VUNG_TUONG_LAI:'MUL - Vững Tương Lai',
        TRON_TAM_AN:'Trọn Tâm An',
        AN_BINH_UU_VIET:'An Bình Ưu Việt'
      };
      const RIDER_NAME_MAP = {
        health_scl:'Sức khỏe Bùng Gia Lực',
        bhn:'Bệnh hiểm nghèo 2.0',
        accident:'Bảo hiểm Tai nạn',
        hospital_support:'Hỗ trợ chi phí nằm viện',
        mdp3:'Miễn đóng phí 3.0'
      };

      function decodePayload() {
        const h = location.hash;
        if (!h.startsWith('#v=')) throw new Error('Không có payload (#v=...)');
        const b64 = h.slice(3);
        const json = decodeURIComponent(escape(atob(b64)));
        return JSON.parse(json);
      }

      function formatNumber(n){
        return (Number(n)||0).toLocaleString('vi-VN');
      }

      function buildFeeTable(p) {
        const c = document.getElementById('feeSection');
        c.innerHTML = '';
        const wrap = document.createElement('div');

        const h2 = document.createElement('h2');
        h2.className = 'section-title';
        h2.textContent = 'Phần 3 · Bảng phí bảo hiểm (dạng chia sẻ)';
        wrap.appendChild(h2);

        const note = document.createElement('div');
        note.className = 'note';
        note.innerHTML = `
          <strong>THÔNG TIN CHÍNH</strong><br>
          Họ tên NĐBH chính: <b>${p.mainPersonName || '—'}</b>
          &nbsp;|&nbsp; Ngày sinh: ${p.mainPersonDob || '—'}
          &nbsp;|&nbsp; Tuổi: ${p.mainPersonAge}
          &nbsp;|&nbsp; Giới tính: ${p.mainPersonGender === 'F' ? 'Nữ' : 'Nam'}
          &nbsp;|&nbsp; Nghề (nhóm rủi ro): ${p.mainPersonRiskGroup ?? '—'}<br>
          Sản phẩm chính: <b>${PRODUCT_NAME_MAP[p.productKey] || p.productKey}</b>
          &nbsp;|&nbsp; STBH: ${formatNumber(p.sumAssured)} đ
          &nbsp;|&nbsp; Kỳ đóng: ${p.paymentFrequency}
          &nbsp;|&nbsp; Thời hạn đóng phí: ${p.paymentTermFinal || p.paymentTerm || '—'} năm
          &nbsp;|&nbsp; Minh họa đến tuổi: ${p.targetAge}
          ${p.mdp3 && p.mdp3.premium ? `<br><i>Đang có quyền lợi miễn đóng phí 3.0: ${formatNumber(p.mdp3.premium)} đ/năm (Người được miễn: ${p.mdp3.selectedName || '—'} - tuổi ${p.mdp3.selectedAge||'?'})</i>`:''}
        `;
        wrap.appendChild(note);

        const tbl = document.createElement('table');
        tbl.innerHTML = `
          <thead>
            <tr>
              <th>Năm HĐ</th>
              <th>Tuổi</th>
              <th>Phí SP chính</th>
              <th>Phí đóng thêm</th>
              <th>Phí SP bổ sung</th>
              <th>Tổng phí (năm)</th>
            </tr>
          </thead>
          <tbody></tbody>`;
        const tbody = tbl.querySelector('tbody');

        const base = p.premiums.baseMain || 0;
        const extra = p.premiums.extra || 0;
        const ridersAnnual = p.premiums.totalSupp || 0;
        const maxYears = Math.max(1, Math.min((p.targetAge - p.mainPersonAge + 1), 30));
        for (let y=1; y<=maxYears; y++){
          const tr = document.createElement('tr');
            const curAge = p.mainPersonAge + y - 1;
            tr.innerHTML = `
              <td>${y}</td>
              <td>${curAge}</td>
              <td>${formatNumber(base)}</td>
              <td>${formatNumber(extra)}</td>
              <td>${formatNumber(ridersAnnual)}</td>
              <td>${formatNumber(base + extra + ridersAnnual)}</td>
            `;
            tbody.appendChild(tr);
        }
        wrap.appendChild(tbl);

        // Chi tiết Riders
        if (Array.isArray(p.premiums.riders) && p.premiums.riders.length){
          const h3 = document.createElement('h3');
          h3.style.margin = '0 0 12px';
          h3.style.fontSize = '16px';
          h3.style.fontWeight = '600';
          h3.textContent = 'Chi tiết sản phẩm bổ sung (phí năm):';
          wrap.appendChild(h3);

          const tbl2 = document.createElement('table');
          tbl2.innerHTML = `
            <thead>
              <tr>
                <th>Sản phẩm</th>
                <th>STBH / Thông số</th>
                <th>Phí năm</th>
                <th>Thông tin thêm</th>
              </tr>
            </thead>
            <tbody></tbody>`;
          const tb2 = tbl2.querySelector('tbody');
          p.premiums.riders.forEach(r => {
            if (!r.selected) return;
            const stbhStr = r.stbh ? formatNumber(r.stbh) : (r.program ? r.program : '—');
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td style="text-align:left">${RIDER_NAME_MAP[r.slug] || r.slug}</td>
              <td>${stbhStr}${r.slug==='hospital_support' ? '/ngày':''}</td>
              <td style="text-align:right">${r.premium?formatNumber(r.premium):'—'}</td>
              <td style="text-align:left">
                ${r.slug==='health_scl'
                  ? `Chương trình: ${r.program || ''}<br>Phạm vi: ${r.scope==='main_global'?'Nước ngoài':'Việt Nam'}${r.outpatient?'<br>Ngoại trú: Có':''}${r.dental?'<br>Nha khoa: Có':''}`
                  : (r.slug==='bhn' ? (r.stbh?`STBH: ${formatNumber(r.stbh)}`:'') : '')}
              </td>
            `;
            tb2.appendChild(tr);
          });
          wrap.appendChild(tbl2);
        }

        c.appendChild(wrap);
      }

      /* ---------- IMAGE HELPERS ---------- */
      async function imageExists(url) {
        try {
          const res = await fetch(url, { method:'HEAD', cache:'no-store' });
          return res.ok;
        } catch(e){ return false; }
      }
      async function findImages(basePath, slug, max=30) {
        const list = [];
        for (let i=1;i<=max;i++){
          const num = String(i).padStart(2,'0');
          const url = `${basePath}/${slug}-${num}.jpg`;
          if (await imageExists(url)) {
            list.push(url);
          } else {
            if (i===1) break;
            else break;
          }
        }
        return list;
      }

      // Bỏ tiêu đề & caption
      function buildGallerySection(images) {
        if (!images.length) return null;
        const section = document.createElement('section');
        section.className = 'gallery-block';
        const list = document.createElement('div');
        list.className = 'gallery-list';
        images.forEach((src)=>{
          const fig = document.createElement('figure');
          const img = document.createElement('img');
          img.loading = 'lazy';
          img.src = src;
          img.alt = '';
          fig.appendChild(img);
          list.appendChild(fig);
          fig.addEventListener('click', ()=>openLightbox(src));
          state.lightboxItems.push(src);
        });
        section.appendChild(list);
        return section;
      }

      async function buildGalleries(p) {
        if (state.galleryBuilt) return;
        state.galleryBuilt = true;
        const anchor = document.getElementById('galleryAnchor');
        if (!anchor) return;

        // Ảnh công ty (luôn trước)
        const company = await findImages('images/company', 'company', 30);
        if (company.length) {
          const sec = buildGallerySection(company);
          if (sec) anchor.parentNode.insertBefore(sec, anchor);
        }

        // Ảnh sản phẩm chính
        const productImages = await findImages(`images/products/${p.productSlug}`, p.productSlug, 50);
        if (productImages.length) {
          const sec = buildGallerySection(productImages);
          if (sec) anchor.parentNode.insertBefore(sec, anchor.nextSibling);
        }

        // Riders
        if (Array.isArray(p.premiums.riders)) {
          for (const r of p.premiums.riders) {
            if (!r.selected) continue;
            const riderSlug = mapRiderSlug(r.slug);
            if (!riderSlug) continue;
            const imgs = await findImages(`images/products/${riderSlug}`, riderSlug, 50);
            if (!imgs.length) continue;
            const sec = buildGallerySection(imgs);
            if (sec) anchor.parentNode.appendChild(sec);
          }
        }
      }

      function mapRiderSlug(slug) {
        const map = {
          health_scl:'bung-gia-luc',
          bhn:'benh-hiem-ngheo-20',
          accident:'tai-nan',
          hospital_support:'ho-tro-vien-phi'
        };
        return map[slug];
      }

      /* ---------- LIGHTBOX ---------- */
      function setupLightbox() {
        const overlay = document.getElementById('lightboxOverlay');
        const img = overlay.querySelector('img');
        const btnPrev = overlay.querySelector('.lb-prev');
        const btnNext = overlay.querySelector('.lb-next');
        const closeBtn = overlay.querySelector('.close-btn');

        function show(idx) {
          if (idx < 0 || idx >= state.lightboxItems.length) return;
          state.lbIndex = idx;
          img.src = state.lightboxItems[idx];
          overlay.classList.add('active');
          updateNav();
        }
        function hide() {
          overlay.classList.remove('active');
          img.src = '';
        }
        function updateNav() {
          btnPrev.disabled = (state.lbIndex <= 0);
          btnNext.disabled = (state.lbIndex >= state.lightboxItems.length - 1);
        }
        function shift(d) {
          const ni = state.lbIndex + d;
          if (ni >=0 && ni < state.lightboxItems.length) show(ni);
        }

        btnPrev.addEventListener('click', ()=>shift(-1));
        btnNext.addEventListener('click', ()=>shift(1));
        closeBtn.addEventListener('click', hide);
        overlay.addEventListener('click', e=>{
          if (e.target === overlay) hide();
        });
        document.addEventListener('keydown', e=>{
          if (!overlay.classList.contains('active')) return;
          if (e.key === 'Escape') hide();
          if (e.key === 'ArrowLeft') shift(-1);
          if (e.key === 'ArrowRight') shift(1);
        });

        window.openLightbox = (src)=>{
          const idx = state.lightboxItems.indexOf(src);
          if (idx !== -1) show(idx);
        };
      }

      function setupButtons() {
        document.getElementById('btnExportPdf').addEventListener('click', ()=> window.print());
        document.getElementById('btnReload').addEventListener('click', ()=> location.reload());
      }

      function openLightbox(src){ if (window.openLightbox) window.openLightbox(src); }

      async function init() {
        setupButtons();
        setupLightbox();
        const statusEl = document.getElementById('status');
        try {
          state.payload = decodePayload();
          statusEl.textContent = 'Đang dựng bảng phí...';
          buildFeeTable(state.payload);
          statusEl.classList.add('hidden');
          await buildGalleries(state.payload);
        } catch(e) {
          console.error(e);
          statusEl.textContent = 'Không đọc được dữ liệu hoặc link hỏng.';
        }
      }

      document.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>
</html>
